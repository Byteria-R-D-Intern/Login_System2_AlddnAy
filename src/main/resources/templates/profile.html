<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil</title>

  <link rel="stylesheet" href="/css/app.css" />

    <script src="/js/auth.js" defer></script>

</head>
<body>
  <div class="container">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="title">Profil Bilgilerim</div>
          <div class="muted">Adres, telefon ve doğum tarihi bilgilerinizi görüntüleyin ve güncelleyin.</div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" id="btnBack">← Geri (Dashboard)</button>
          <button class="btn btn-danger" id="btnLogout">Çıkış</button>
        </div>
        </div>
    </div>
    
    <!-- Mesaj alanı -->
    <div id="profileMessage" class="message hidden"></div>

    <!-- Yükleniyor -->
    <div id="loading" class="card">
      Yükleniyor...
    </div>
    
    <!-- Profil görüntüleme kartı -->
    <div id="profileView" class="card hidden">
      <div class="row">
        <div class="field">
          <label>Kullanıcı ID</label>
          <input id="viewUserId" type="text" disabled />
        </div>
        <div class="field">
          <label>Doğum Tarihi</label>
          <input id="viewBirthDate" type="text" disabled />
            </div>
                </div>
      <div class="row">
        <div class="field">
          <label>Telefon</label>
          <input id="viewTelefon" type="text" disabled />
                </div>
        <div class="field">
          <label>Adres</label>
          <textarea id="viewAdres" rows="3" disabled></textarea>
                </div>
            </div>

      <div class="actions">
        <button class="btn btn-primary" id="btnEdit">Profili Düzenle</button>
            </div>
        </div>
        
    <!-- Profil düzenleme/oluşturma formu -->
    <div id="profileFormCard" class="card hidden">
            <form id="profileForm">
        <div class="row">
          <div class="field">
            <label>Doğum Tarihi</label>
            <input id="birthDate" name="birthDate" type="date" />
                </div>
          <div class="field">
            <label>Telefon</label>
            <input id="telefon" name="telefon" type="text" placeholder="+90..." />
                </div>
                </div>
        <div class="field" style="margin-top: 8px;">
          <label>Adres</label>
          <textarea id="adres" name="adres" rows="3" placeholder="Adresiniz..."></textarea>
                </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit" id="btnSave">Kaydet</button>
          <button class="btn btn-secondary" type="button" id="btnCancel">İptal</button>
                    </div>
                </form>
            </div>

    <!-- Profil yoksa oluşturma çağrısı -->
    <div id="profileCreateHint" class="card hidden">
      <div class="muted">Profil bulunamadı. Aşağıdaki formdan profil oluşturabilirsiniz.</div>
      <div class="actions" style="margin-top: 8px;">
        <button class="btn btn-primary" id="btnCreateStart">Profil Oluştur</button>
        </div>
    </div>
</div>


<script>

    let currentProfile = null;
    let isEditing = false;
    let isCreating = false;

    const el = {
    msg: document.getElementById('profileMessage'),
    loading: document.getElementById('loading'),
    view: document.getElementById('profileView'),
    formCard: document.getElementById('profileFormCard'),
    form: document.getElementById('profileForm'),
    createHint: document.getElementById('profileCreateHint'),
    btnBack: document.getElementById('btnBack'),
    btnLogout: document.getElementById('btnLogout'),
    btnEdit: document.getElementById('btnEdit'),
    btnCancel: document.getElementById('btnCancel'),
    btnCreateStart: document.getElementById('btnCreateStart'),
    viewUserId: document.getElementById('viewUserId'),
    viewBirthDate: document.getElementById('viewBirthDate'),
    viewTelefon: document.getElementById('viewTelefon'),
    viewAdres: document.getElementById('viewAdres'),
    birthDate: document.getElementById('birthDate'),
    telefon: document.getElementById('telefon'),
    adres: document.getElementById('adres'),
    btnSave: document.getElementById('btnSave')
    };

    function showMessage(text, type) {
    el.msg.textContent = text;
    el.msg.classList.remove('hidden', 'success', 'error');
    el.msg.classList.add(type);
    }
    function clearMessage() {
    el.msg.classList.add('hidden');
    el.msg.textContent = '';
    }

    function showOnly(section) {
    [el.loading, el.view, el.formCard, el.createHint].forEach(s => s.classList.add('hidden'));
    section.classList.remove('hidden');
    }
    function showLoading() { showOnly(el.loading); }
    function showView() { showOnly(el.view); }
    function showForm() { showOnly(el.formCard); }
    function showCreateHint() { showOnly(el.createHint); }

    document.addEventListener('DOMContentLoaded', async () => {
        const session = Auth.ensureAuthenticated();
        if (!session) return;
        const userId = session.userId;

        el.btnBack.addEventListener('click', () => {
            window.location.href = '/dashboard';
        });

        el.btnLogout.addEventListener('click', () => {
            Auth.logout();
        });

        el.btnEdit.addEventListener('click', startEditMode);
        el.btnCreateStart.addEventListener('click', startCreateMode);
        el.btnCancel.addEventListener('click', cancelEditing);
        el.form.addEventListener('submit', handleSave);

        await loadProfile(userId);
    });

    async function loadProfile(userId) {
        clearMessage();
        showLoading();

        try {
            const response = await Auth.authFetch(`/api/user/profile/${userId}`);

            if (response.ok) {
            currentProfile = await response.json();
            fillView(currentProfile);
            isEditing = false;
            isCreating = false;
            showView();
            } else if (response.status === 404 || response.status === 403) {
            currentProfile = null;
            showCreateHint();
        } else {
            showMessage('Profil yüklenemedi. Lütfen tekrar deneyin.', 'error');
            showView();
            }
        } catch (err) {
            console.error('Profil yükleme hatası:', err);
            showMessage('Sunucu hatası. Lütfen tekrar deneyin.', 'error');
            showView();
        }
    }

    function fillView(profile) {
        el.viewUserId.value = profile.userId ?? profile.id ?? '';
        el.viewBirthDate.value = formatDateForDisplay(profile.birthDate);
        el.viewTelefon.value = profile.telefon ?? '';
        el.viewAdres.value = profile.adres ?? '';
        }

 
        function formatDateForDisplay(value) {
        if (!value) return '';
        if (typeof value === 'string') {

            return value.substring(0, 10);
        }
        try {
            const d = new Date(value);
            if (isNaN(d.getTime())) return String(value);
            return d.toISOString().substring(0, 10);
        } catch {
            return String(value);
        }
    }
    function startEditMode() {
        if (!currentProfile) return;
        isEditing = true;
        isCreating = false;
        clearMessage();
        fillForm(currentProfile);
        showForm();
    }

    function startCreateMode() {
        isEditing = false;
        isCreating = true;
        clearMessage();
        clearForm();
        showForm();
    }

    function cancelEditing() {
        isEditing = false;
        isCreating = false;
        clearMessage();
        if (currentProfile) showView();
        else showCreateHint();
    }

    function fillForm(profile) {
        el.birthDate.value = formatDateForDisplay(profile.birthDate);
        el.telefon.value = profile.telefon ?? '';
        el.adres.value = profile.adres ?? '';
    }

    function clearForm() {
        el.birthDate.value = '';
        el.telefon.value = '';
        el.adres.value = '';
    }

    async function handleSave(e) {
        e.preventDefault();
        clearMessage();

        const session = Auth.ensureAuthenticated();
        if (!session) return;
        const { userId } = session;

        // Basit doğrulama (opsiyonel)
        const payload = {
            birthDate: el.birthDate.value || null,
            telefon: (el.telefon.value || '').trim(),
            adres: (el.adres.value || '').trim()
        };
        if (!payload.telefon && !payload.adres && !payload.birthDate) {
            showMessage('Lütfen en az bir alanı doldurun.', 'error');
        return;
    }
    
        // UI: Kaydet butonunu kilitle
        el.btnSave.disabled = true;
        const originalText = el.btnSave.textContent;
        el.btnSave.textContent = '⏳ Kaydediliyor...';

        try {
            const method = isEditing ? 'PUT' : 'POST';
            const url = `/api/user/profile/${userId}`;

            const response = await Auth.authFetch(url, {
            method,
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            showMessage(isEditing ? 'Profil güncellendi.' : 'Profil oluşturuldu.', 'success');
            isEditing = false;
            isCreating = false;
            await loadProfile(userId); // Görüntüyü tazele
            } else if (response.status === 403) {
            showMessage('Yetkiniz yok. Yalnızca kendi profilinizi yönetebilirsiniz.', 'error');
            } else if (response.status === 400) {
            showMessage('Geçersiz istek. Lütfen alanları kontrol edin.', 'error');
        } else {
            showMessage('İşlem başarısız. Lütfen tekrar deneyin.', 'error');
            }
        } catch (err) {
            console.error('Profil kaydetme hatası:', err);
            showMessage('Sunucu hatası. Lütfen tekrar deneyin.', 'error');
    } finally {
            el.btnSave.textContent = originalText;
            el.btnSave.disabled = false;
        }
    }

</script>
</body>
</html>
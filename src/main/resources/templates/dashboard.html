<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - EÄŸitim Platformu</title>
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body class="dashboard-page">

<div class="dashboard-container">
    <div class="header">
        <div class="welcome-section">
            <h1>ğŸ“ EÄŸitim Platformu Dashboard</h1>
            <div class="user-info">
                <span id="welcomeMessage">HoÅŸ geldin!</span> | 
                <span id="userRole">KullanÄ±cÄ±</span>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
    
    <div id="successMessage" class="success-message" style="display: none;">
        BaÅŸarÄ±yla giriÅŸ yaptÄ±nÄ±z! ğŸ‰
    </div>
    
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3 class="card-title">ğŸ“‹ GÃ¶revlerim</h3>
            <p class="card-description">
                GÃ¶revlerinizi gÃ¶rÃ¼ntÃ¼leyin, dÃ¼zenleyin ve yeni gÃ¶revler oluÅŸturun.
            </p>
            <a href="#" class="card-btn" onclick="openTasks()">GÃ¶revleri GÃ¶rÃ¼ntÃ¼le</a>
        </div>
        
        <div class="dashboard-card">
            <h3 class="card-title">ğŸ‘¤ Profil YÃ¶netimi</h3>
            <p class="card-description">
                Profil bilgilerinizi gÃ¶rÃ¼ntÃ¼leyin ve gÃ¼ncelleyin.
            </p>
            <a href="#" class="card-btn" onclick="openProfile()">Profili DÃ¼zenle</a>
        </div>
        
        <div class="dashboard-card">
            <h3 class="card-title">ğŸ“š API DokÃ¼mantasyonu</h3>
            <p class="card-description">
                Swagger UI ile API endpoint'lerini test edin.
            </p>
            <a href="/swagger-ui/index.html" class="card-btn" target="_blank">API'yi KeÅŸfet</a>
        </div>

        <div class="dashboard-card" id="notificationsCard" style="grid-column: 1 / -1;">
            <h3 class="card-title">ğŸ”” Bildirimlerim</h3>
            <div id="notifLoading" class="muted" style="display:none;">YÃ¼kleniyor...</div>
            <div id="notifEmpty" class="muted" style="display:none;"></div>
            <div id="notifList"></div>
            <div style="margin-top:12px;">
                <a href="#" class="card-btn" onclick="openNotifications()">Bildirimleri GÃ¶rÃ¼ntÃ¼le</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Token kontrolÃ¼
    const token = localStorage.getItem('authToken');
    const userEmail = localStorage.getItem('userEmail');
    
    if (!token) {
        // Token yoksa login'e yÃ¶nlendir
        window.location.href = '/login';
        return;
    }
    
    // KullanÄ±cÄ± bilgilerini gÃ¶ster
    if (userEmail) {
        document.getElementById('welcomeMessage').textContent = `HoÅŸ geldin, ${userEmail}`;
    }
    
    // RolÃ¼ JWT'den belirle ve UI/localStorage'a yaz
    let resolvedRole = null;
    try {
        resolvedRole = window.Auth?.getRoleFromToken(token) || null;
    } catch (e) {
        console.warn('Role parse error:', e);
    }
    if (resolvedRole) {
        localStorage.setItem('userRole', resolvedRole);
    } else {
        localStorage.removeItem('userRole');
    }
    const roleText = {
        'USER': 'ğŸ‘¨â€ğŸ“ Ã–ÄŸrenci',
        'MANAGER': 'ğŸ‘” EÄŸitmen', 
        'ADMIN': 'ğŸ‘‘ YÃ¶netici'
    };
    document.getElementById('userRole').textContent = roleText[resolvedRole] || (resolvedRole || 'KullanÄ±cÄ±');
    if (resolvedRole === 'ADMIN') {
        window.location.href = '/admin';
        return;
    }
    if (resolvedRole === 'MANAGER') {
        window.location.href = '/manager';
        return;
    }
    
    // BaÅŸarÄ± mesajÄ±nÄ± gÃ¶ster
    document.getElementById('successMessage').style.display = 'block';
    setTimeout(() => {
        document.getElementById('successMessage').style.display = 'none';
    }, 5000);

    // Bildirimleri yÃ¼kle (sadece USER/MANAGER iÃ§in dashboardta gÃ¶ster)
    loadNotifications();
});


function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    window.location.href = '/login';
}

// GÃ¶revler sayfasÄ±
function openTasks() {
    window.location.href = '/tasks';
}

// Profil sayfasÄ±
function openProfile() {
    window.location.href = '/profile';
}
function openNotifications() {
    window.location.href = '/notifications';
}
async function loadNotifications() {
  const loading = document.getElementById('notifLoading');
  const empty = document.getElementById('notifEmpty');
  const list = document.getElementById('notifList');
  loading.style.display = 'block';
  empty.style.display = 'none';
  list.innerHTML = '';
  try {
    const res = await Auth.authFetch('/api/notifications');
    loading.style.display = 'none';
    if (!res.ok) { empty.style.display = 'block'; return; }
    const items = await res.json();
    const titleEl = document.querySelector('#notificationsCard .card-title');
    if (titleEl) titleEl.textContent = `ğŸ”” Bildirimlerim (${items?.length ?? 0})`;
    if (!items || items.length === 0) { empty.style.display = 'block'; return; }
    items.forEach(n => {
      const div = document.createElement('div');
      div.className = 'notif-item';
      div.innerHTML = `<div><strong>${escapeHtml(n.title || '')}</strong></div>
                       <div>${escapeHtml(n.message || '')}</div>
                       <div class='muted'>${(n.createdAt || '').toString().substring(0,16).replace('T',' ')}</div>`;
      list.appendChild(div);
    });
  } catch (e) {
    loading.style.display = 'none';
    empty.style.display = 'block';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function openAdmin() {
  const role = localStorage.getItem('userRole');
  if (role !== 'ADMIN') {
    alert('Bu alan sadece ADMIN iÃ§in!');
    return;
  }
  window.location.href = '/admin';
}

function openManagerArea() {
  const role = localStorage.getItem('userRole');
  if (role !== 'MANAGER') {
    alert('Bu alan sadece EÄŸitmen (MANAGER) iÃ§in!');
    return;
  }

  window.location.href = '/manager';
}

</script>

</body>
</html>
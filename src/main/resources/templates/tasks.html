<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Görevlerim - Eğitim Platformu</title>
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/task.css">
    <script src="/js/auth.js" defer></script>
</head>
<body class="tasks-page">

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">📋 Görevlerim</h1>
        <div class="header-buttons">
            <button class="btn btn-success" onclick="openCreateTaskModal()">➕ Yeni Görev</button>
            <a href="/dashboard" class="btn btn-primary">🏠 Dashboard</a>
            <button class="btn btn-danger" onclick="logout()">🚪 Çıkış</button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters">
        <div class="filter-group">
            <label>🔍 Başlık Ara</label>
            <input type="text" id="titleFilter" class="filter-input" placeholder="Görev başlığı..." onkeyup="filterTasks()">
        </div>
        <div class="filter-group">
            <label>📊 Durum</label>
            <select id="statusFilter" class="filter-input" onchange="filterTasks()">
                <option value="">Tümü</option>
                <option value="PENDING">Bekliyor</option>
                <option value="IN_PROGRESS">Devam Ediyor</option>
                <option value="COMPLETED">Tamamlandı</option>
            </select>
        </div>
        <div class="filter-group">
            <label>🎯 Öncelik</label>
            <select id="priorityFilter" class="filter-input" onchange="filterTasks()">
                <option value="">Tümü</option>
                <option value="LOW">Düşük</option>
                <option value="MEDIUM">Orta</option>
                <option value="HIGH">Yüksek</option>
            </select>
        </div>
        <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="clearFilters()">🗑️ Temizle</button>
        </div>
    </div>
    
    <!-- Loading -->
    <div id="loadingMessage" class="loading">
        <h3>⏳ Görevler yükleniyor...</h3>
    </div>
    
    <!-- Tasks Grid -->
    <div id="tasksContainer" class="tasks-grid" style="display: none;">
        <!-- Tasks will be loaded here -->
    </div>
    
    <!-- No Tasks -->
    <div id="noTasksMessage" class="no-tasks" style="display: none;">
        <h3>📝 Henüz göreviniz yok</h3>
        <p>Yeni bir görev oluşturmak için "Yeni Görev" butonuna tıklayın.</p>
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">➕ Yeni Görev Oluştur</h2>
            <span class="close" onclick="closeTaskModal()">&times;</span>
        </div>
        <form id="taskForm">
            <div class="form-group">
                <label for="taskTitle">📝 Başlık *</label>
                <input type="text" id="taskTitle" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="taskDescription">📄 Açıklama</label>
                <textarea id="taskDescription" class="form-control" placeholder="Görev detayları..."></textarea>
            </div>
            <div class="form-group">
                <label for="taskStatus">📊 Durum</label>
                <select id="taskStatus" class="form-control">
                    <option value="PENDING">Bekliyor</option>
                    <option value="IN_PROGRESS">Devam Ediyor</option>
                    <option value="COMPLETED">Tamamlandı</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskPriority">🎯 Öncelik</label>
                <select id="taskPriority" class="form-control">
                    <option value="LOW">Düşük</option>
                    <option value="MEDIUM" selected>Orta</option>
                    <option value="HIGH">Yüksek</option>
                </select>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-success" style="width: 100%;">💾 Kaydet</button>
            </div>
        </form>
    </div>
</div>

<script>
let allTasks = [];
let currentEditingTaskId = null;

// UI <-> API Status mapping (Frontend uses EN, Backend expects TR)
const UI_TO_API_STATUS = {
    PENDING: 'YAPILACAK',
    IN_PROGRESS: 'DEVAM_EDIYOR',
    COMPLETED: 'BITTI'
};
const API_TO_UI_STATUS = {
    YAPILACAK: 'PENDING',
    DEVAM_EDIYOR: 'IN_PROGRESS',
    BITTI: 'COMPLETED'
};

document.addEventListener('DOMContentLoaded', function() {
    // Token kontrolü
    const token = localStorage.getItem('authToken');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    // Tasks'ları yükle
    loadTasks();
    
    // Form submit handler
    document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
});

// Tasks'ları API'den yükle
async function loadTasks() {
    const token = localStorage.getItem('authToken');
    
    try {
        const response = await fetch('/api/tasks', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            allTasks = await response.json();
            // Convert API status (TR) to UI status (EN) for rendering/filtering
            allTasks = allTasks.map(t => ({
                ...t,
                status: API_TO_UI_STATUS[t.status] || t.status
            }));
            displayTasks(allTasks);
        } else if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        } else {
            throw new Error('Tasks yüklenemedi');
        }
    } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('loadingMessage').innerHTML = 
            '<h3>❌ Görevler yüklenirken hata oluştu</h3><p>Lütfen sayfayı yenileyin.</p>';
    }
}
// Tasks'ları ekranda göster
function displayTasks(tasks) {
    const container = document.getElementById('tasksContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const noTasksMessage = document.getElementById('noTasksMessage');
    
    loadingMessage.style.display = 'none';
    
    if (tasks.length === 0) {
        container.style.display = 'none';
        noTasksMessage.style.display = 'block';
        return;
    }
    
    noTasksMessage.style.display = 'none';
    container.style.display = 'grid';
    
    container.innerHTML = tasks.map(task => `
        <div class="task-card">
            <h3 class="task-title">${escapeHtml(task.title)}</h3>
            <p class="task-description">${escapeHtml(task.description || 'Açıklama yok')}</p>
            <div class="task-meta">
                <span class="status-badge status-${task.status.toLowerCase()}">${getStatusText(task.status)}</span>
                <span class="priority-badge priority-${task.priority.toLowerCase()}">${getPriorityText(task.priority)}</span>
            </div>
            <div class="task-actions">
                <button class="btn btn-primary btn-sm" onclick="editTask(${task.id})">✏️ Düzenle</button>
                <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">🗑️ Sil</button>
            </div>

            <div class="task-actions" style="margin-top:8px;">
            <button class="btn btn-secondary btn-sm" onclick="toggleAssignments(${task.id})">👥 Atamalar</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleComments(${task.id})">💬 Yorumlar</button>
            </div>

            <div id="details-${task.id}" class="task-details" style="display:none; margin-top:10px;">
            <div id="assignments-${task.id}" class="card" style="margin-bottom:8px;"></div>
            <div id="comments-${task.id}" class="card"></div>
            </div>
        </div>
    `).join('');
}

// Task oluştur/düzenle modal'ını aç
function openCreateTaskModal() {
    currentEditingTaskId = null;
    document.getElementById('modalTitle').textContent = '➕ Yeni Görev Oluştur';
    document.getElementById('taskForm').reset();
    document.getElementById('taskModal').style.display = 'block';
}

function editTask(taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;
    
    currentEditingTaskId = taskId;
    document.getElementById('modalTitle').textContent = '✏️ Görev Düzenle';
    document.getElementById('taskTitle').value = task.title;
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskStatus').value = task.status;
    document.getElementById('taskPriority').value = task.priority;
    document.getElementById('taskModal').style.display = 'block';
}

function closeTaskModal() {
    document.getElementById('taskModal').style.display = 'none';
    currentEditingTaskId = null;
}

// Task form submit
async function handleTaskSubmit(e) {
    e.preventDefault();
    
    const token = localStorage.getItem('authToken');
    const taskData = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        status: document.getElementById('taskStatus').value,
        priority: document.getElementById('taskPriority').value
    };

    // Convert UI status (EN) to API status (TR) before sending
    taskData.status = UI_TO_API_STATUS[taskData.status] || taskData.status;
    
    const submitButton = document.querySelector('#taskForm button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = '⏳ Kaydediliyor...';
    submitButton.disabled = true;
    
    try {
        let response;
        if (currentEditingTaskId) {
            // Update task
            response = await fetch(`/api/tasks/${currentEditingTaskId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            });
        } else {
            // Create task
            // Provide ownerId as required by backend DTO
            try {
                const session = window.Auth ? Auth.ensureAuthenticated() : null;
                if (session && session.userId) {
                    taskData.ownerId = session.userId;
                }
            } catch (e) {
                console.warn('Auth not available for ownerId extraction', e);
            }
            response = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(taskData)
            });
        }
        
        if (response.ok) {
            closeTaskModal();
            loadTasks(); // Refresh task list
            showNotification(`Görev başarıyla ${currentEditingTaskId ? 'güncellendi' : 'oluşturuldu'}!`, 'success');
        } else {
            throw new Error('Task kaydedilemedi');
        }
    } catch (error) {
        console.error('Error saving task:', error);
        showNotification('Görev kaydedilirken hata oluştu!', 'error');
    } finally {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    }
}

// Task sil
async function deleteTask(taskId) {
    if (!confirm('Bu görevi silmek istediğinizden emin misiniz?')) {
        return;
    }
    
    const token = localStorage.getItem('authToken');
    
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            loadTasks(); // Refresh task list
            showNotification('Görev başarıyla silindi!', 'success');
        } else {
            throw new Error('Task silinemedi');
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        showNotification('Görev silinirken hata oluştu!', 'error');
    }
}

// Filtreleme
function filterTasks() {
    const titleFilter = document.getElementById('titleFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    
    const filteredTasks = allTasks.filter(task => {
        const titleMatch = task.title.toLowerCase().includes(titleFilter);
        const statusMatch = !statusFilter || task.status === statusFilter;
        const priorityMatch = !priorityFilter || task.priority === priorityFilter;
        
        return titleMatch && statusMatch && priorityMatch;
    });
    
    displayTasks(filteredTasks);
}

function clearFilters() {
    document.getElementById('titleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    displayTasks(allTasks);
}

// Utility functions
function getStatusText(status) {
    const statusMap = {
        'PENDING': 'Bekliyor',
        'IN_PROGRESS': 'Devam Ediyor',
        'COMPLETED': 'Tamamlandı'
    };
    return statusMap[status] || status;
}

function getPriorityText(priority) {
    const priorityMap = {
        'LOW': 'Düşük',
        'MEDIUM': 'Orta',
        'HIGH': 'Yüksek'
    };
    return priorityMap[priority] || priority;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showNotification(message, type) {
    // Basit notification - daha sonra geliştirebiliriz
    alert(message);
}

// ============== Assignments (Görev Atamaları) ==============
// API yardımcıları
async function fetchAssignments(taskId) {
    const res = await (window.Auth ? Auth.authFetch(`/api/task-assignments/task/${taskId}`) : fetch(`/api/task-assignments/task/${taskId}`));
    return res.ok ? res.json() : [];
}
async function assignTask(taskId, assignedToId, message) {
    const body = JSON.stringify({ taskId, assignedToId, message });
    return window.Auth
        ? Auth.authFetch(`/api/task-assignments`, { method: 'POST', body })
        : fetch(`/api/task-assignments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
}
async function respondAssignment(assignmentId, response, message) {
    const body = JSON.stringify({ response, message });
    return window.Auth
        ? Auth.authFetch(`/api/task-assignments/${assignmentId}/respond`, { method: 'PUT', body })
        : fetch(`/api/task-assignments/${assignmentId}/respond`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body });
}

// Panel aç/kapat
async function toggleAssignments(taskId) {
    const panel = document.getElementById(`details-${taskId}`);
    const assignmentsBox = document.getElementById(`assignments-${taskId}`);
    const commentsBox = document.getElementById(`comments-${taskId}`);
    if (!panel || !assignmentsBox || !commentsBox) return;

    // Aç ve sadece atamaları göster
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        assignmentsBox.style.display = 'block';
        commentsBox.style.display = 'none';
        await renderAssignments(taskId);
        return;
    }

    // Panel açık: atamalar açık ise kapat, değilse atamaları göster (yorumları gizle)
    const isAssignmentsVisible = assignmentsBox.style.display !== 'none';
    if (isAssignmentsVisible) {
        panel.style.display = 'none';
        assignmentsBox.style.display = 'none';
    } else {
        assignmentsBox.style.display = 'block';
        commentsBox.style.display = 'none';
        await renderAssignments(taskId);
    }
}

// Render
async function renderAssignments(taskId) {
    const container = document.getElementById(`assignments-${taskId}`);
    if (!container) return;
    container.innerHTML = 'Yükleniyor...';

    const assignments = await fetchAssignments(taskId);
    const session = window.Auth ? Auth.ensureAuthenticated() : null;
    const me = session?.userId;
    const myRole = session?.role;

    const listHtml = assignments.map(a => {
        const isPending = a.status === 'PENDING' || a.status === 'BEKLEMEDE' || a.status === 'PENDING'.toUpperCase();
        const iAmAssignee = a.assignedToId === me;
        const actions = (isPending && iAmAssignee)
            ? `<div style="margin-top:6px;">
                 <button class="btn btn-primary btn-sm" onclick="respondAssignmentUI(${a.id}, 'ACCEPTED', ${taskId})">✅ Kabul</button>
                 <button class="btn btn-danger btn-sm" onclick="respondAssignmentUI(${a.id}, 'REJECTED', ${taskId})">❌ Reddet</button>
               </div>`
            : '';

        return `
          <div style="border-bottom:1px solid #eee; padding:8px 0;">
            <div><b>#${a.id}</b> • ${escapeHtml(a.taskTitle || '')} • ${escapeHtml(String(a.status))}</div>
            <div>Atayan: ${escapeHtml(a.assignedByName || '')} → Atanan: ${escapeHtml(a.assignedToName || '')}</div>
            ${a.message ? `<div class="muted">Mesaj: ${escapeHtml(a.message)}</div>` : ''}
            ${actions}
          </div>`;
    }).join('') || '<div class="muted">Atama yok</div>';

    const assignForm = (myRole === 'ADMIN' || myRole === 'MANAGER')
        ? `
          <div style="margin-top:10px;">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
              <input id="assignTo-${taskId}" type="number" placeholder="Kullanıcı ID" style="width:140px;"/>
              <input id="assignMsg-${taskId}" type="text" placeholder="Mesaj (opsiyonel)" style="flex:1; min-width:180px;"/>
              <button class="btn btn-primary btn-sm" onclick="submitAssignmentUI(${taskId})">➕ Ata</button>
            </div>
          </div>
        ` : '';

    container.innerHTML = `
      <div style="font-weight:600; margin-bottom:6px;">Atamalar</div>
      ${listHtml}
      ${assignForm}
    `;
}

async function submitAssignmentUI(taskId) {
    const assignedToId = Number(document.getElementById(`assignTo-${taskId}`).value);
    const message = document.getElementById(`assignMsg-${taskId}`).value.trim();
    if (!assignedToId) {
        showNotification('Atanacak kullanıcı ID zorunlu', 'error');
        return;
    }
    const res = await assignTask(taskId, assignedToId, message);
    if (res.ok) {
        showNotification('Atama yapıldı', 'success');
        await renderAssignments(taskId);
    } else {
        showNotification('Atama yapılamadı', 'error');
    }
}

async function respondAssignmentUI(assignmentId, response, taskId) {
    const message = prompt('Opsiyonel mesaj (boş bırakabilirsiniz):') || '';
    const res = await respondAssignment(assignmentId, response, message);
    if (res.ok) {
        showNotification(`Atama ${response === 'ACCEPTED' ? 'kabul edildi' : 'reddedildi'}`, 'success');
        await renderAssignments(taskId);
    } else {
        showNotification('Yanıt gönderilemedi', 'error');
    }
}

// ============== Comments (Görev Yorumları) ==============
// API yardımcıları
async function fetchComments(taskId) {
    const res = await (window.Auth ? Auth.authFetch(`/api/task-comments/task/${taskId}`) : fetch(`/api/task-comments/task/${taskId}`));
    return res.ok ? res.json() : [];
}
async function addComment(taskId, comment) {
    const body = JSON.stringify({ taskId, comment });
    return window.Auth
        ? Auth.authFetch(`/api/task-comments`, { method: 'POST', body })
        : fetch(`/api/task-comments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
}
async function deleteComment(commentId) {
    return window.Auth
        ? Auth.authFetch(`/api/task-comments/${commentId}`, { method: 'DELETE' })
        : fetch(`/api/task-comments/${commentId}`, { method: 'DELETE' });
}

// Panel aç/kapat
async function toggleComments(taskId) {
    const panel = document.getElementById(`details-${taskId}`);
    const assignmentsBox = document.getElementById(`assignments-${taskId}`);
    const commentsBox = document.getElementById(`comments-${taskId}`);
    if (!panel || !assignmentsBox || !commentsBox) return;

    // Aç ve sadece yorumları göster
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        assignmentsBox.style.display = 'none';
        commentsBox.style.display = 'block';
        await renderComments(taskId);
        return;
    }

    // Panel açık: yorumlar açık ise kapat, değilse yorumları göster (atamaları gizle)
    const isCommentsVisible = commentsBox.style.display !== 'none';
    if (isCommentsVisible) {
        panel.style.display = 'none';
        commentsBox.style.display = 'none';
    } else {
        assignmentsBox.style.display = 'none';
        commentsBox.style.display = 'block';
        await renderComments(taskId);
    }
}

// Render
async function renderComments(taskId) {
    const container = document.getElementById(`comments-${taskId}`);
    if (!container) return;
    container.innerHTML = 'Yükleniyor...';

    const comments = await fetchComments(taskId);
    const session = window.Auth ? Auth.ensureAuthenticated() : null;
    const me = session?.userId;
    const myRole = session?.role;

    const listHtml = comments.map(c => {
        const canDelete = (c.user?.id === me) || (myRole === 'ADMIN' || myRole === 'MANAGER');
        const delBtn = canDelete
            ? `<button class="btn btn-danger btn-sm" style="margin-left:8px;" onclick="deleteCommentUI(${c.id}, ${taskId})">🗑️ Sil</button>`
            : '';
        return `
          <div style="border-bottom:1px solid #eee; padding:8px 0;">
            <div><b>${escapeHtml(c.user?.email || 'Kullanıcı')}</b> • <span class="muted">${escapeHtml(c.taskTitle || '')}</span></div>
            <div>${escapeHtml(c.comment || '')}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(c.createdAt || '')}</div>
            ${delBtn}
          </div>`;
    }).join('') || '<div class="muted">Yorum yok</div>';

    container.innerHTML = `
      <div style="font-weight:600; margin-bottom:6px;">Yorumlar</div>
      ${listHtml}
      <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
        <input id="newComment-${taskId}" type="text" placeholder="Yorum yazın..." style="flex:1; min-width:220px;"/>
        <button class="btn btn-primary btn-sm" onclick="addCommentUI(${taskId})">➕ Ekle</button>
      </div>
    `;
}

async function addCommentUI(taskId) {
    const input = document.getElementById(`newComment-${taskId}`);
    const comment = (input.value || '').trim();
    if (!comment) {
        showNotification('Yorum boş olamaz', 'error');
        return;
    }
    const res = await addComment(taskId, comment);
    if (res.ok) {
        input.value = '';
        showNotification('Yorum eklendi', 'success');
        await renderComments(taskId);
    } else {
        showNotification('Yorum eklenemedi (yetki/validasyon)', 'error');
    }
}

async function deleteCommentUI(commentId, taskId) {
    const ok = confirm('Yorumu silmek istiyor musunuz?');
    if (!ok) return;
    const res = await deleteComment(commentId);
    if (res.ok) {
        showNotification('Yorum silindi', 'success');
        await renderComments(taskId);
    } else {
        showNotification('Yorum silinemedi', 'error');
    }
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    window.location.href = '/login';
}

// Modal dışına tıklanınca kapat
window.onclick = function(event) {
    const modal = document.getElementById('taskModal');
    if (event.target === modal) {
        closeTaskModal();
    }
}
</script>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Admin - T端m Loglar</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <link rel="stylesheet" href="/css/task.css" />
    <script src="/js/auth.js" defer></script>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #e5e5e5; text-align: left; }
        th { background: #f7f7f7; }
        code { font-size: 12px; }
    </style>
    </head>
<body>
<div class="container">
    <h2>T端m Loglar</h2>
    <table id="logsTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Zaman</th>
            <th>Task</th>
            <th>Actor</th>
            <th>Target</th>
            <th>Aksiyon</th>
            <th>Mesaj</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="log : ${logs}">
            <td th:text="${log.id}"></td>
            <td th:text="${#temporals.format(log.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
            <td th:text="${log.task != null ? log.task.id : '-'}"></td>
            <td th:text="${log.actor != null ? log.actor.name : '-'}"></td>
            <td th:text="${log.target != null ? log.target.name : '-'}"></td>
            <td th:text="${log.action}"></td>
            <td th:text="${log.message}"></td>
        </tr>
        </tbody>
    </table>
</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const session = Auth.ensureAuthenticated();
  if (!session) return;
  await loadLogs();
});

async function loadLogs() {
  try {
    const res = await Auth.authFetch('/api/task-logs/all');
    if (!res.ok) { alert('Loglar y端klenemedi'); return; }
    const logs = await res.json();
    renderLogs(logs);
  } catch (e) {
    alert('Loglar y端klenemedi');
  }
}

function renderLogs(logs) {
  const tbody = document.querySelector('#logsTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  (logs || []).forEach(l => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.id}</td>
      <td>${(l.createdAt || '').toString().substring(0,16).replace('T',' ')}</td>
      <td>${l.taskId ?? '-'}</td>
      <td>${l.actorName ?? ''}</td>
      <td>${l.targetName ?? ''}</td>
      <td>${l.action}</td>
      <td>${escapeHtml(l.message || '')}</td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>


